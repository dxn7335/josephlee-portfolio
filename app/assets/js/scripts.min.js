/*!
 * josephlee-portfolio
 * Joseph Lee - UX/Visual Designer
 * http://mingtastic.com
 * @author Danny Nguyen (danny-nguyen.com)
 * @version 1.0.0
 * Copyright 2015. MIT licensed.
 */
'use strict';

// Main Router /////////////////////////////////////////////////////////////////////////////
var app = angular.module('App', 
	['ui.router', 
	 'home.controller', 
	 'work.controller',
	 'header.controller',
	 'about.controller',
	 'workHeader.controller',
	 'worknav.controller'
	])
	.config(function ( $stateProvider, $urlRouterProvider, $locationProvider ) {
		'use strict';
		// configure urls
		$urlRouterProvider.when('/work', '/about', '/');
		$urlRouterProvider.otherwise('/');

		//state
		$stateProvider
			.state('work', {
				url: '/work/:id',
				views:{
						'header':{
							templateUrl: 'assets/templates/global/work-header.html',
							controller: 'headerController',
						},
						'work-sect':{
								'templateUrl': function($stateParams){
									console.log($stateParams.id);
									return 'assets/templates/'+$stateParams.id+".html";
								},
								'controller': 'workController', // map js to html scope
						},
						'work-nav':{
							templateUrl: 'assets/templates/global/work-navigation.html',
							controller: 'workNavController',
						},
					'footer':{
							templateUrl: 'assets/templates/global/footer.html',
						}
				}
			})
			.state('about',{
					url: "/about/",
					views:{
							'header':{
								templateUrl: 'assets/templates/global/header.html',
								controller: 'headerController', // map js to html scope
							},
							'about':{
								templateUrl: 'assets/templates/about.html',
								controller: 'aboutController', // map js to html scope
							},
							'footer':{
								templateUrl: 'assets/templates/global/footer.html',
							}
					}
				})
			.state('home',{
				url: "/",
				views:{
						'header':{
							templateUrl: 'assets/templates/global/header.html',
							controller: 'headerController', // map js to html scope
						},
						'home':{
							templateUrl: 'assets/templates/home.html',
							controller: 'homeController', // map js to html scope
						},
						'footer':{
							templateUrl: 'assets/templates/global/footer.html',
						}
				}
			});
	});
// Main Service for Work Data //////////////////////////////////
// Pulls in list of work
angular.module('data.service', [])
		.service('dataService', [ '$q','$http', function($q, $http){
			this.promise = null;
	
			function makeRequest() {
					 return $http.get('assets/data/workConfig.json')
							 .then(function(resp){
										return resp.data;
							 });
			}
		
			//will only get data if no call has been made already
			this.getPromise = function(update){
				if (update || !this.promise) {
					 this.promise = makeRequest();
				}
				return this.promise;      
			}
		}]);

// About Controller /////////////////////////////////////////////////////////////////////////////
angular.module('about.controller', [])

    .controller('aboutController', [
        '$scope', '$sce', '$stateParams', '$timeout',
        function ($scope, $sce, $stateParams, $timeout){
					$('body').addClass("home");
					
					$timeout( function(){
					
					}, 0);
    }])
//Header Navigation Controller /////////////////////////////////////////////////////////////////////////////
angular.module('header.controller', [])

    .controller('headerController', [
        '$scope', '$sce', '$stateParams', '$timeout', '$location',
        function ($scope, $sce, $stateParams, $timeout, $location){
			
	}])

	.run( function(){
	})

	.directive("mainNav", ['$timeout','$location', function ($timeout, $location) {
		return {
			link: function (scope, elem, attr){
				var el = $(elem);

				$timeout( function(){
					// Header Scroll Listener
					var distance = el.height() + 60;
					$(window).scroll(function(){
							if( $(window).scrollTop() >= distance ){
								$('#scroll-nav').addClass('show');
							} else{
								$('#scroll-nav').removeClass('show');
							}
					})
					
					el.find(".nav-links a").removeClass("active");
					// mark current page on nav-links
					if( $location.$$path.indexOf("about") != -1){
						el.find(".nav-links a[data-target='about']").addClass("active");
					} else{
						el.find("#home-nav .nav-links a[data-target='home']").addClass("active");
					}
				}, 0);
			}
		};
	}])

	.directive("mobileMenuInteraction", ['$timeout', function ($timeout) {
		return {
			link: function (scope, elem, attr) {

				$timeout( function(){

					$(elem).find(".mobilemenu-btn").on("click", function(e){
						e.preventDefault();

						// use toggle attr to keep track of open status of mobile menu
						var toggle = $(elem).data('toggle')||0,
							mobileBtn = $(elem).find(".mobilemenu-btn");

						switch(toggle){
							case 0:
								$(mobileBtn).addClass("click");
								$("body").addClass("mobile-open");
								console.log($(elem).closest('nav').find("#mobile-nav"));
								$(elem).closest('header').find("#mobile-nav").fadeIn(300);
								$(elem).closest('nav').addClass('mobile-menu-open');
								break;
							case 1:
								$(mobileBtn).removeClass("click");
								$("body").removeClass("mobile-open");
								$(elem).closest('header').find("#mobile-nav").fadeOut(300);
								$(elem).closest('nav').removeClass('mobile-menu-open');
								break;
						}
						toggle ++;
						if(toggle > 1) toggle = 0;
						console.log(toggle);
						$(elem).data('toggle', toggle);
					});

				}, 0);
			}
		};
	}])

	.directive("mobileNav", ['$timeout', function ($timeout) {
		return {
			link: function (elem){
				//close mobile nav when a link is clicked
				$('#mobile-nav .nav-links a').on('click', function(){
					$('.mobilemenu-btn').data('toggle',0);
					$('.mobilemenu-btn').removeClass('click');
					$("body").removeClass("mobile-open");
					$("#mobile-nav").fadeOut(300);
				});
			}
		};
	}]);


//Home Controller /////////////////////////////////////////////////////////////////////////////
angular.module('home.controller', ['data.service'])

    .controller('homeController', [
        '$scope', '$sce', '$stateParams', 'dataService',
        function ($scope, $sce, $stateParams, dataService){
        	$('body').addClass("home");
					$("html, body").animate({ scrollTop: 0 }, "fast");
					$scope.works = [];
					
					//Make sure works list has been loaded
					dataService.getPromise().then(function(data){
						//when data is loaded
						$scope.works = data.works;
						
					}, function(err){
						console.log(err);
					});
					
		
    }])

	.directive('workItemRepeat', function() {
		return function(scope, element, attrs) {
			if (scope.$last){
				scope.$emit('LastElem');
			}
		};
	})
	
	.directive('workItemContainer', function() {
		return function(scope, element, attrs) {
			scope.$on('LastElem', function(event){
				setTimeout( function(){
					$(".workitem").each( function(i){
						var _this = this;
						setTimeout( function(){
							$(_this).addClass('active');
						}, 210*i);
					});
				}, 250);
				
				//listener
				$(".workitem").on('click', function(e) {
					setTimeout( function(){
						$(".workitem").each( function(i){
							var _this = this;
							setTimeout( function(){
								$(_this).removeClass('active');
							}, 200*i);
						});
					}, 150);
				});
				
			});
			//end
		};
	});
//Work Controller /////////////////////////////////////////////////////////////////////////////
angular.module('work.controller', [])

	.controller('workController', [
			'$scope', '$sce', '$stateParams', '$timeout',
			function ($scope, $sce, $stateParams, $timeout){
				
			}
	])

	.run(function($rootScope){
		$rootScope.$on('$stateChangeSuccess', function() {
			$("html, body").animate({ scrollTop: 0 }, "fast");
		});	
	})

	.directive('workPage', [ '$timeout', function ($timeout) {
		return {
			link: function(scope, elem){
				$('body').removeClass('home');
				$("html, body").animate({ scrollTop: 0 }, "fast");
				$timeout( function(){

					//init image slider
					$(elem).find('.img-slider').slick({
						dots: true,
						infinite: true,
						arrows: false,
						speed: 400,
						slidesToShow: 1
					});

					$(elem).find('.slick-slider').css("height", "auto");

				}, 0);
			}
		};
	}]);
//Header Navigation Controller /////////////////////////////////////////////////////////////////////////////
/* ALL WRONG */
// Any dom manipulation or listeners should be done through directives (these actions can affect the $scope of a model)
angular.module('workHeader.controller', [])

    .controller('workHeaderController', [
        '$scope', '$sce', '$stateParams', '$timeout',
        function ($scope, $sce, $stateParams, $timeout){
					
					$timeout( function(){
						// Header Scroll Listener
						var distance = 1;
						$(window).scroll(function(){
								if( $(window).scrollTop() >= distance ){
									$("#work-main-nav").addClass('scroll');
								} else{
									$("#work-main-nav").removeClass('scroll');
								}
						})
						
						$(".mobilemenu-btn").on("click", function(){
						var toggle = $('.mobilemenu-btn').data('toggle')||0
						switch(toggle){
							case 0:
								$(".mobilemenu-btn").addClass("click");
								$("body").addClass("mobile-open");
								$("#mobile-nav").fadeIn(300);
								break;
							case 1:
								$(".mobilemenu-btn").removeClass("click");
								$("body").removeClass("mobile-open");
								$("#mobile-nav").fadeOut(300);
								break;
						}
						toggle ++;
						if(toggle > 1) toggle = 0;
						$('.mobilemenu-btn').data('toggle', toggle);
					});

					//close mobile nav when a link is clicked
					$('#mobile-nav .nav-links a').on('click', function(){
						$('.mobilemenu-btn').data('toggle',0);
						$('.mobilemenu-btn').removeClass('click');
						$("body").removeClass("mobile-open");
						$("#mobile-nav").fadeOut(300);
					});
						
					}, 0);
    }])

		.run( function(){
		});
//Work Navigation Controller /////////////////////////////////////////////////////////////////////////////
// Used to navigate between project pages
angular.module('worknav.controller', ['data.service'])

    .controller('workNavController', [
        '$scope', '$sce', '$stateParams', 'dataService',
        function ($scope, $sce, $stateParams, dataService){
        	$scope.works = [];
					$scope.prev = {};
					$scope.next = {};
					
					//Make sure works list has been loaded
					dataService.getPromise().then(function(data){
						//when data is loaded
						console.log($stateParams);
						$scope.works = data.works;
						for(var i=0; i<$scope.works.length; i++){
							// Find current index in works array
							// create links for viewing previous or next proj
							// (if no prev or no next proj), don't show link
							if( $stateParams.id == $scope.works[i].id ){
								if( $scope.works[i-1] ){ $scope.prev = {id:$scope.works[i-1].id}; }
								else{ $scope.prev = {invalid:"invalid"}; }
								if( $scope.works[i+1] ){ $scope.next = {id:$scope.works[i+1].id}; }
								else{ $scope.next = {invalid:"invalid"}; }
								
								$(".process-link").attr("href", "assets/img/"+$scope.works[i].id+"/"+$scope.works[i].process);
							}
						}
					}, function(err){
						console.log(err);
					});
    }]);